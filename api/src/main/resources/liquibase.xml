<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

	<changeSet author="raff" id="20120730-1340">
		<comment>Create the hl7query_template table</comment>
		<createTable tableName="hl7query_template">
			<column name="hl7query_template_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="uuid" type="char(38)">
				<constraints nullable="false" unique="true" />
			</column>
			<column name="creator" type="int">
				<constraints nullable="false" />
			</column>
			<column name="date_created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="retired" type="boolean" defaultValueBoolean="false">
				<constraints nullable="false" />
			</column>
			<column name="retired_by" type="int" />
			<column name="date_retired" type="datetime" />
			<column name="retire_reason" type="varchar(255)" />
			<column name="changed_by" type="int" />
			<column name="date_changed" type="datetime" />

			<column name="name" type="varchar(255)">
				<constraints nullable="false" unique="true" />
			</column>
			<column name="description" type="varchar(255)" />

			<column name="language" type="varchar(50)" defaultValue="groovy">
				<constraints nullable="false" />
			</column>
			<column name="hl7_entity" type="varchar(50)" />
			<column name="template" type="clob">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>
	<changeSet author="raff" id="20120730-1345">
		<comment>Add creator FK to hl7query_template</comment>
		<addForeignKeyConstraint constraintName="hl7query_template_creator"
			baseTableName="hl7query_template" baseColumnNames="creator"
			referencedTableName="users" referencedColumnNames="user_id" />
	</changeSet>
	<changeSet author="raff" id="20120730-1350">
		<comment>Add retired_by FK to hl7query_template</comment>
		<addForeignKeyConstraint constraintName="hl7query_template_retired_by"
			baseTableName="hl7query_template" baseColumnNames="retired_by"
			referencedTableName="users" referencedColumnNames="user_id" />
	</changeSet>
	<changeSet author="raff" id="20120730-1530">
		<comment>Add changed_by FK to hl7query_template</comment>
		<addForeignKeyConstraint constraintName="hl7query_template_changed_by"
			baseTableName="hl7query_template" baseColumnNames="changed_by"
			referencedTableName="users" referencedColumnNames="user_id" />
	</changeSet>

 
 	<changeSet author="JUDY" id="20130731-1740">
		<comment>Add values for Default patient name  template to the hl7queryTemplate table</comment>
		<insert tableName="hl7query_template">
			<column name="name" value="Default Patient Name"></column>
			<column name="description" value="Template for the PID.5 segment"></column>
			<column name="hl7_entity" value="PID.5"></column>
			<column name="language" value="groovy"></column>
			<column name="creator" valueNumeric="1"></column>
			<column name="date_created" valueDate="2012-07-31"></column>
			<column name="retired" valueBoolean="false"></column>
			<column name="uuid" value="AADDCCf4-15f6-104d-91f4-000c22c2DABC"></column>
			<column name="template">
				<![CDATA[
					<PID.5> 
						for (patientName in patient.getNames()) { 
			             	<XPN.1><FN.1>${encounter.getPatient().getFamilyName()}</FN.1></XPN.1>
			         		<XPN.2>${encounter.getPatient().getGivenName()}</XPN.2>
			         		<XPN.3>${encounter.getPatient().getMiddleName()}</XPN.3>
			         	}	         			
					</PID.5>
    				]]>
			</column>
		</insert>		
	</changeSet>
 
 <changeSet author="JUDY" id="20120801-0522">
		<comment>Add values for Default patient Identifier template</comment>
		<insert tableName="hl7query_template">
			<column name="name" value="Default Patient Identifier"></column>
			<column name="description" value="Template for the PID.3 segment"></column>
			<column name="hl7_entity" value="PID.3"></column>
			<column name="language" value="groovy"></column>
			<column name="creator" valueNumeric="1"></column>
			<column name="date_created" valueDate="2012-08-01"></column>
			<column name="retired" valueBoolean="false"></column>
			<column name="uuid" value="AADDCCf4-18f6-184d-91f4-000c22c2DYUC"></column>
			<column name="template">
				<![CDATA[
					<PID.5> 
						for (patientname in patient.getNames()) { 
			             	<XPN.1><FN.1>${patient.getFamilyName()}</FN.1></XPN.1>
			         		<XPN.2>${patient.getGivenName()}</XPN.2>
			         		<XPN.3>${patient.getMiddleName()}</XPN.3>
			         	}	         			
    				</PID.5>
    				
    				<PID.3> 
    				for (identifier in patient.getpatientIdentifier()){
      <CX.1>patient.patientIdentifier.identifier</CX.1> <!-- displays the id number -->
      <CX.5>patient.patientIdentifierType.name</CX.5> <!-- displays the name of the identifier type  -->
  </PID.3>
    				]]>
			</column>
		</insert>		
	</changeSet>


</databaseChangeLog>